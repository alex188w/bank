<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ë–∞–Ω–∫ ‚Äî –°—á–µ—Ç–∞ –∏ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            line-height: 1.5;
        }

        h1,
        h3 {
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 60%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 8px 10px;
            text-align: center;
        }

        input,
        select,
        button {
            margin: 5px;
            padding: 5px 8px;
        }

        .section {
            margin-bottom: 30px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <h1>üí∞ –ë–∞–Ω–∫ ‚Äî —Å—á–µ—Ç–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç</h1>

    <!-- üîÅ –ë–ª–æ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ -->
    <div class="section">
        <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç</h3>
        <label>–ò–∑:</label>
        <select id="fromCurrency">
            <option>USD</option>
            <option>EUR</option>
            <option>RUB</option>
        </select>

        <label>–í:</label>
        <select id="toCurrency">
            <option>USD</option>
            <option>EUR</option>
            <option>RUB</option>
        </select>

        <input id="amount" type="number" placeholder="–°—É–º–º–∞" />
        <button onclick="convertCurrency()">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <span id="result"></span>
    </div>

    <!-- üßæ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ -->
    <div class="section">
        <h3>–°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç</h3>
        <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
        <input id="currency" placeholder="–í–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä USD)" />
        <button onclick="createAccount()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div class="section">
        <h3>–°—á–µ—Ç–∞</h3>
        <button onclick="loadAccounts()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <table id="accountsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–í–∞–ª—é—Ç–∞</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const API = 'http://localhost:8080/api/accounts';
        const CASH_API = 'http://localhost:8080/api/cash';
        const EXCHANGE_API = 'http://localhost:8080/api/exchange';

        async function loadAccounts() {
            const res = await fetch(API);
            const accounts = await res.json();
            const tbody = document.querySelector('#accountsTable tbody');
            tbody.innerHTML = '';
            accounts.forEach(acc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${acc.id}</td>
                    <td>${acc.currency}</td>
                    <td>${acc.balance}</td>
                    <td>
                        <button onclick="deposit(${acc.id})">–ü–æ–ª–æ–∂–∏—Ç—å 100</button>
                        <button onclick="withdraw(${acc.id})">–°–Ω—è—Ç—å 100</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        async function createAccount() {
            const currency = document.getElementById('currency').value;
            const username = document.getElementById('username').value;
            await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username,
                    ownerId: username,
                    currency,
                    balance: 0
                })
            });
            loadAccounts();
        }

        async function deposit(id) {
            try {
                const res = await fetch(`${CASH_API}/deposit/${id}?amount=100`, { method: 'POST' });
                if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);
                setTimeout(loadAccounts, 500);
            } catch (err) {
                console.error("Deposit failed:", err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—á—ë—Ç–∞");
            }
        }

        async function withdraw(id) {
            await fetch(`${API}/${id}/withdraw?amount=100`, { method: 'POST' });
            loadAccounts();
        }

        async function convertCurrency() {
            const from = document.getElementById('fromCurrency').value;
            const to = document.getElementById('toCurrency').value;
            const amount = document.getElementById('amount').value;
            const resultSpan = document.getElementById('result');

            try {
                const res = await fetch(`${EXCHANGE_API}/convert?from=${from}&to=${to}&amount=${amount}`);
                if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);
                const data = await res.json();
                resultSpan.textContent = `= ${data.result.toFixed(2)} ${to}`;
            } catch (err) {
                console.error("Conversion failed:", err);
                resultSpan.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏";
            }
        }

        loadAccounts();
    </script>
</body>

</html>