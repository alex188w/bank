<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ë–∞–Ω–∫ ‚Äî –°—á–µ—Ç–∞ –∏ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            line-height: 1.5;
        }

        h1,
        h3 {
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 70%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 8px 10px;
            text-align: center;
        }

        input,
        select,
        button {
            margin: 3px;
            padding: 5px 8px;
        }

        .section {
            margin-bottom: 30px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        input.amount-input {
            width: 80px;
            text-align: right;
        }
    </style>
</head>

<body>
    <h1>üí∞ –ë–∞–Ω–∫ ‚Äî —Å—á–µ—Ç–∞ –∏ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç</h1>

    <!-- <h2>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>
    <table id="ratesTable" border="1">
        <thead>
            <tr>
                <th>–í–∞–ª—é—Ç–∞</th>
                <th>–ü–æ–∫—É–ø–∫–∞</th>
                <th>–ü—Ä–æ–¥–∞–∂–∞</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table> -->

    <!-- üîÅ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç -->
    <div class="section">
        <h3>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ RUB)</h3>
        <button onclick="loadRates()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <table id="ratesTable">
            <thead>
                <tr>
                    <th>–í–∞–ª—é—Ç–∞</th>
                    <th>–ü–æ–∫—É–ø–∫–∞</th>
                    <th>–ü—Ä–æ–¥–∞–∂–∞</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- üßæ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ -->
    <div class="section">
        <h3>–°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç</h3>
        <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
        <input id="currency" placeholder="–í–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä USD)" />
        <button onclick="createAccount()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div class="section">
        <h3>–°—á–µ—Ç–∞</h3>
        <button onclick="loadAccounts()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <table id="accountsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–í–∞–ª—é—Ç–∞</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const API = 'http://localhost:8080/api/accounts';
        const CASH_API = 'http://localhost:8080/api/cash';
        const EXCHANGE_API = 'http://localhost:8084/exchange';

        // async function loadRates() {
        //     const res = await fetch(`${EXCHANGE_API}/rates`);
        //     const rates = await res.json();
        //     const tbody = document.querySelector('#ratesTable tbody');
        //     tbody.innerHTML = '';
        //     rates.forEach(rate => {
        //         const tr = document.createElement('tr');
        //         tr.innerHTML = `
        //             <td>${rate.currency}</td>
        //             <td>${rate.buy}</td>
        //             <td>${rate.sell}</td>`;
        //         tbody.appendChild(tr);
        //     });
        // }

        async function loadAccounts() {
            const res = await fetch(API);
            const accounts = await res.json();
            const tbody = document.querySelector('#accountsTable tbody');
            tbody.innerHTML = '';
            accounts.forEach(acc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${acc.id}</td>
                    <td>${acc.currency}</td>
                    <td>${acc.balance}</td>
                    <td><input id="amount-${acc.id}" class="amount-input" type="number" min="1" value=""></td>
                    <td>
                        <button onclick="deposit(${acc.id})">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                        <button onclick="withdraw(${acc.id})">–°–Ω—è—Ç—å</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        async function createAccount() {
            const currency = document.getElementById('currency').value;
            const username = document.getElementById('username').value;
            await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username,
                    ownerId: username,
                    currency,
                    balance: 0
                })
            });
            loadAccounts();
        }

        async function deposit(id) {
            const amount = document.getElementById(`amount-${id}`).value || 0;
            try {
                const res = await fetch(`${CASH_API}/deposit/${id}?amount=${amount}`, { method: 'POST' });
                if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);
                setTimeout(loadAccounts, 300);
            } catch (err) {
                console.error("Deposit failed:", err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—á—ë—Ç–∞");
            }
        }

        async function withdraw(id) {
            const amount = document.getElementById(`amount-${id}`).value || 0;
            try {
                const res = await fetch(`${API}/${id}/withdraw?amount=${amount}`, { method: 'POST' });
                if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);
                setTimeout(loadAccounts, 300);
            } catch (err) {
                console.error("Withdraw failed:", err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤");
            }
        }

        async function loadRates() {
            try {
                const res = await fetch(`${EXCHANGE_API}/rates`);
                if (!res.ok) throw new Error(res.statusText);
                const rates = await res.json();

                const tbody = document.querySelector('#ratesTable tbody');
                tbody.innerHTML = '';
                rates.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${r.currency}</td>
                <td>${(+r.buy).toFixed(2)}</td>
                <td>${(+r.sell).toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—É—Ä—Å–æ–≤:', err);
            }
        }

        // –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(loadRates, 300);

        // –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
        setInterval(loadRates, 60000);
        loadAccounts();
    </script>
</body>

</html>