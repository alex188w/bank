pipeline {
  agent { label 'bank-agent' }

  environment {
    CHART_PATH   = "helm-charts/bank-platform/charts/kaffka-service"
    RELEASE_NAME = "kaffka-service"
  }

  parameters {
    choice(
      name: 'DEPLOY_ENV',
      choices: ['dev', 'test', 'prod'],
      description: 'Namespace / окружение'
    )
    booleanParam(
      name: 'RECREATE_TOPICS',
      defaultValue: false,
      description: 'Пересоздать топики (делает hook Job post-upgrade)'
    )
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Helm Lint (Kafka)') {
      steps {
        sh "helm lint ${CHART_PATH}"
      }
    }

    stage('Deploy / Upgrade Kafka') {
      steps {
        script {
          def ns = params.DEPLOY_ENV

          sh """
            helm upgrade --install ${RELEASE_NAME} ${CHART_PATH} \
              --namespace ${ns} --create-namespace \
              -f ${CHART_PATH}/values.yaml \
              --set topics.enabled=true \
              --set topics.recreate=${params.RECREATE_TOPICS} \
              --set topics.bootstrapServer=kaffka-service:9092
          """
        }
      }
    }

    stage('Kafka Smoke Check') {
      steps {
        script {
          def ns = params.DEPLOY_ENV
          def pod = sh(
            script: "kubectl get pods -n ${ns} -l app=${RELEASE_NAME} -o jsonpath='{.items[0].metadata.name}'",
            returnStdout: true
          ).trim()

          sh """
            echo "Kafka topics in namespace=${ns}, pod=${pod}:"
            kubectl exec -n ${ns} ${pod} -- /opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || true
          """
        }
      }
    }
  }

  post {
    success { echo "Kafka (${RELEASE_NAME}) deployed/updated in namespace=${params.DEPLOY_ENV}. RECREATE_TOPICS=${params.RECREATE_TOPICS}" }
    failure { echo "Kafka (${RELEASE_NAME}) deploy/upgrade FAILED in namespace=${params.DEPLOY_ENV}" }
  }
}